library(dplyr)
library(lubridate)


# ?????????????????????????? ???????????????? ?????????
time_check <- function(day, place) {
  if ((place >= 5 & place <= 12) | (place >= 400 & place <= 1200)) {
    return(TRUE)
  }
  return (FALSE)
}

dset <- c("dataset1","dataset2","dataset3","dataset4","dataset5")
num = 0 # key ????????????? count

for (q in dset) {
  
  # ????? ????????? ?????????????????????? ????????
  mon_length = 0
  tue_length = 0
  wed_length = 0
  thu_length = 0
  fri_length = 0
  
  # ????? ????????? ???????? ?????????????
  mon_cnt = 0
  tue_cnt = 0
  wed_cnt = 0
  thu_cnt = 0
  fri_cnt = 0
  
  print(q)
  
  title = paste(q,"_placecleanfinal.csv",sep="")
  pdata = read.csv(title)
  
  place_list = as.numeric(as.character(pdata$Place))
  date_list = as.Date(pdata$Date)
  sp_list= ymd_hms(pdata$Startpoint)
  ep_list = ymd_hms(pdata$Endpoint)
  day_list = weekdays(as.Date(pdata$Date))
  difference_list = as.numeric(as.character(pdata$Difference))
  lenp = length(pdata$Place)
  
  # ?????????? date???? ???????? 
  for (i in (1:lenp)) {
    date = date_list[i]
    day = day_list[i]
    sp = sp_list[i]
    ep = ep_list[i]
    difference = difference_list[i]
    place = place_list[i]
    
    # 11?????-14????? ???????? ?????????????? ?????????
    if (hour(sp) >= 11 & hour(ep) <= 14) {
      # ???????????????????? ?????????????????? ?????????????? ?????, ????????? ????????????? ??????????????
      
      
      if (time_check(day, place) == TRUE) { # ?????????????????????? ?????????
        
        
        if (day == "Monday") {
          mon_length = mon_length + difference
          mon_cnt = mon_cnt + 1
        }
        else if (day == "Tuesday") {
          tue_length = tue_length + difference
          tue_cnt = tue_cnt + 1
        }
        else if (day == "Wednesday") {
          wed_length = wed_length + difference
          wed_cnt = wed_cnt + 1
        }
        else if (day == "Thursday") {
          thu_length = thu_length + difference
          thu_cnt = thu_cnt + 1
        }
        else if (day == "Friday") {
          fri_length = fri_length + difference
          fri_cnt = fri_cnt + 1
        }
      }
    }
  }
  
  # ??????????????????? ?????????? ??????????????
  mon_avg = mon_length / mon_cnt
  tue_avg = tue_length / tue_cnt
  wed_avg = wed_length / wed_cnt
  thu_avg = thu_length / thu_cnt
  fri_avg = fri_length / fri_cnt
  
  # ???????????????????????? ?????????? list ?????????? ?????????
  final_date_list = unique(date_list) # ?????????? ??????????????? ?????????? ???????????????
  
  # ???????????????????????? ?????????????? ????????? ????????? vector ?????????
  Sys.setlocale("LC_TIME", "English")
  final_day_list = weekdays(as.Date(final_date_list))
  
  # ??????????????????? ????????? vector ?????????
  time_list <- c()
  
  # ????????????? ??????????? ???????? ??????????????????? ?????????? vector ?????????
  for (i in (1:length(final_day_list))) {
    if (final_day_list[i] == "Monday") {
      time = mon_avg
    }
    else if (final_day_list[i] == "Tuesday") {
      time = tue_avg
    }
    else if (final_day_list[i] == "Wednesday") {
      time = wed_avg
    }
    else if (final_day_list[i] == "Thursday") {
      time = thu_avg
    }
    else if (final_day_list[i] == "Friday") {
      time = fri_avg
    }
    else { # ????????????? ????????? 0?????????? ???????????
      time = 0
    }
    # time_vec???? ????????????????????
    time_list = append(time_list, time, after=(i-1))
  }
  
  
  # key ?????????
  num = num + 1
  key = paste("G",as.character(num),sep="") # ????????? ??????????? ??????????????? ??????????
  
  # ????????? ????????? ???????????
  dsave = data.frame(key, final_date_list, final_day_list, time_list)
  colnames(dsave) = c('Key','Date','Day','AvailableTime')
  
  # ??????????????? Time.csv????? ?????????????? ????????????????????
  dfile <- paste("Time.csv",sep="")
  
  # ?????????? dataset??????????????? ????????? ??????????????? ????? ????????????? CSV????????? ?????????????????? ????????????????
  if (!file.exists(dfile)){
    write.csv(dsave,file = dfile,row.names = F)
  }
  else{
    write.table(dsave, dfile, row.names = F, col.names = F, append = T, sep= ",")
  }
  
}
